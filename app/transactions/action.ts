'use server'

import { TransactionType } from '@prisma/client'
import { prisma } from '@/lib/prisma'; // ‚úÖ ‡πÉ‡∏ä‡πâ Prisma instance ‡∏à‡∏≤‡∏Å lib
import { revalidatePath } from 'next/cache'
import { z } from 'zod'

// Schema ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transaction
const CreateTransactionSchema = z.object({
  amount: z.coerce
    .number({ invalid_type_error: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç' })
    .positive({ message: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0' }),
  type: z.nativeEnum(TransactionType, { // ‡πÉ‡∏ä‡πâ nativeEnum ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö enum ‡∏à‡∏≤‡∏Å Prisma
    errorMap: () => ({ message: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô INCOME ‡∏´‡∏£‡∏∑‡∏≠ EXPENSE)' }),
  }),
  // title: z.string().min(1, { message: '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤' }), // ‡∏•‡∏ö title ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å schema
  category: z.string().min(1, { message: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤' }),
})

export async function createTransactionAction(formData: FormData) {
  const validatedFields = CreateTransactionSchema.safeParse({
    amount: formData.get('amount'),
    type: formData.get('type'), // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å FormData ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô string, Prisma ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡πâ‡∏≤ type ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö enum
    // title: formData.get('title'), // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á title ‡∏à‡∏≤‡∏Å formData
    category: formData.get('category'),
  })

  if (!validatedFields.success) {
    return {
      success: false,
      errors: validatedFields.error.flatten().fieldErrors,
      message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å',
    }
  }

  const { amount, type, category } = validatedFields.data // ‡∏•‡∏ö title ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å destructuring

  try {
    const newTransaction = await prisma.transaction.create({
      data: {
        amount,
        type,
        // title, // ‡∏•‡∏ö title ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á transaction
        category,
      },
    })
    revalidatePath('/transactions') // ‡∏õ‡∏£‡∏±‡∏ö path ‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    return { success: true, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', data: newTransaction }
  } catch (error) {
    console.error("üî¥ [Transaction Action Error] Failed to create transaction:", error);
    return {
      success: false,
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log ‡∏Ç‡∏≠‡∏á Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)'
    }
  }
}
